import { PrismaClient, UserRole, TemplateSecteur } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  console.log('üå± Starting seed...')

  // 1. Cr√©er des templates r√©utilisables
  console.log('Creating templates...')

  const templates = await Promise.all([
    // Templates E-commerce
    prisma.template.create({
      data: {
        titre: '[SEO - Gaps] Cr√©ation pages listes de produits',
        categorie: 'Contenu SEO',
        secteur: TemplateSecteur.ECOMMERCE,
        description: 'Cr√©ation de pages cat√©gories virtuelles avec ElasticSuite pour combler les gaps SEO et am√©liorer le positionnement organique',
        budgetMoyen: 10000,
        delaiMoyen: 2,
        scoresDefaults: {
          impactBusiness: 9,
          complexite: 2
        },
        kpiSuggeres: ['Trafic SEO', 'Positions organiques', 'Pages index√©es']
      }
    }),
    prisma.template.create({
      data: {
        titre: 'Cross-Selling & Recommandations personnalis√©es',
        categorie: 'Conversion',
        secteur: TemplateSecteur.ECOMMERCE,
        description: 'Mise en place d\'un syst√®me de recommandations produits intelligent bas√© sur l\'IA pour augmenter le panier moyen',
        budgetMoyen: 7000,
        delaiMoyen: 1,
        scoresDefaults: {
          impactBusiness: 9,
          complexite: 4
        },
        kpiSuggeres: ['Panier moyen', 'Taux de conversion', 'CA par visite']
      }
    }),
    prisma.template.create({
      data: {
        titre: 'Optimisation du Checkout',
        categorie: 'Conversion',
        secteur: TemplateSecteur.ECOMMERCE,
        description: 'Refonte du tunnel de commande pour r√©duire l\'abandon panier et am√©liorer le taux de conversion',
        budgetMoyen: 15000,
        delaiMoyen: 3,
        scoresDefaults: {
          impactBusiness: 10,
          complexite: 6
        },
        kpiSuggeres: ['Taux d\'abandon', 'Taux de conversion', 'Commandes']
      }
    }),
    prisma.template.create({
      data: {
        titre: 'Gestion des stocks temps r√©el',
        categorie: 'Logistique',
        secteur: TemplateSecteur.ECOMMERCE,
        description: 'Int√©gration API avec syst√®me de gestion des stocks pour affichage en temps r√©el de la disponibilit√© produits',
        budgetMoyen: 4000,
        delaiMoyen: 1,
        scoresDefaults: {
          impactBusiness: 7,
          complexite: 3
        },
        kpiSuggeres: ['Satisfaction client', 'Retours produits', 'Fiabilit√© stock']
      }
    }),
    prisma.template.create({
      data: {
        titre: 'Module Carte Cadeau',
        categorie: 'Conversion',
        secteur: TemplateSecteur.ECOMMERCE,
        description: 'Mise en place d\'un syst√®me de cartes cadeaux digitales avec personnalisation et envoi automatique',
        budgetMoyen: 4000,
        delaiMoyen: 1,
        scoresDefaults: {
          impactBusiness: 8,
          complexite: 2
        },
        kpiSuggeres: ['CA cartes cadeaux', 'Nouveaux clients', 'Panier moyen']
      }
    }),

    // Templates Marketing
    prisma.template.create({
      data: {
        titre: 'Programme de fid√©lit√©',
        categorie: 'Fid√©lisation',
        secteur: TemplateSecteur.MARKETING,
        description: 'Cr√©ation d\'un programme de points de fid√©lit√© avec gamification pour augmenter la r√©tention client',
        budgetMoyen: 12000,
        delaiMoyen: 4,
        scoresDefaults: {
          impactBusiness: 8,
          complexite: 5
        },
        kpiSuggeres: ['Taux de r√©tention', 'Fr√©quence d\'achat', 'LTV client']
      }
    }),
    prisma.template.create({
      data: {
        titre: 'Campagnes email automatis√©es',
        categorie: 'Marketing automation',
        secteur: TemplateSecteur.MARKETING,
        description: 'Setup de sc√©narios d\'emails automatis√©s (panier abandonn√©, relance, upsell) pour maximiser le CA',
        budgetMoyen: 5000,
        delaiMoyen: 2,
        scoresDefaults: {
          impactBusiness: 7,
          complexite: 3
        },
        kpiSuggeres: ['Taux d\'ouverture', 'Taux de clic', 'CA g√©n√©r√©']
      }
    }),

    // Templates IT/Performance
    prisma.template.create({
      data: {
        titre: 'Optimisation performances site',
        categorie: 'Performance',
        secteur: TemplateSecteur.IT,
        description: 'Audit et optimisation des performances web (Core Web Vitals, temps de chargement, cache)',
        budgetMoyen: 8000,
        delaiMoyen: 2,
        scoresDefaults: {
          impactBusiness: 7,
          complexite: 4
        },
        kpiSuggeres: ['Page Speed Score', 'Temps de chargement', 'Taux de rebond']
      }
    }),
    prisma.template.create({
      data: {
        titre: 'Migration technique',
        categorie: 'Infrastructure',
        secteur: TemplateSecteur.IT,
        description: 'Migration vers nouvelle infrastructure/plateforme avec plan de recette et rollback',
        budgetMoyen: 25000,
        delaiMoyen: 8,
        scoresDefaults: {
          impactBusiness: 6,
          complexite: 9
        },
        kpiSuggeres: ['Uptime', 'Performance', 'Co√ªts infrastructure']
      }
    }),

    // Templates UX/Accessibilit√©
    prisma.template.create({
      data: {
        titre: 'Am√©lioration accessibilit√© (RGAA)',
        categorie: 'Accessibilit√©',
        secteur: TemplateSecteur.ECOMMERCE,
        description: 'Mise en conformit√© du site avec les standards d\'accessibilit√© RGAA/WCAG pour √©largir l\'audience',
        budgetMoyen: 30000,
        delaiMoyen: 12,
        scoresDefaults: {
          impactBusiness: 5,
          complexite: 8
        },
        kpiSuggeres: ['Score accessibilit√©', 'Audience touch√©e', 'Conformit√© l√©gale']
      }
    }),
  ])

  console.log(`‚úÖ Created ${templates.length} templates`)

  // 2. Cr√©er des clients (tenants)
  console.log('Creating clients...')

  const clientEcommerce = await prisma.client.create({
    data: {
      nom: 'Acme E-commerce',
      slug: 'acme',
      logo: null,
      couleurPrimaire: '#E63946',
      couleurSecondaire: '#1D3557',
      statut: 'ACTIF',
      criteresScoring: {
        impactBusiness: {
          label: 'Impact Business',
          description: 'Potentiel CA, croissance, acquisition clients',
          weight: 50
        },
        complexite: {
          label: 'Complexit√©',
          description: 'Complexit√© technique + gestion du changement',
          weight: 25
        },
        budgetScore: {
          label: 'Budget',
          description: 'Score invers√© : budget faible = meilleur score',
          weight: 25
        }
      }
    }
  })

  const clientDemo = await prisma.client.create({
    data: {
      nom: 'Demo Corp',
      slug: 'demo',
      couleurPrimaire: '#3B82F6',
      couleurSecondaire: '#1E40AF',
      statut: 'ACTIF'
    }
  })

  console.log(`‚úÖ Created 2 clients`)

  // 3. Cr√©er des utilisateurs
  console.log('Creating users...')

  const superAdmin = await prisma.user.create({
    data: {
      email: 'admin@outilsdecision.fr',
      nom: 'Admin',
      prenom: 'Super',
      role: UserRole.SUPER_ADMIN,
      clientId: clientEcommerce.id,
      supabaseId: 'super-admin-id' // √Ä remplacer par l'ID Supabase r√©el
    }
  })

  const adminAcme = await prisma.user.create({
    data: {
      email: 'admin@acme.fr',
      nom: 'Martin',
      prenom: 'Jean',
      role: UserRole.ADMIN,
      clientId: clientEcommerce.id,
      supabaseId: 'admin-acme-id'
    }
  })

  const editorAcme = await prisma.user.create({
    data: {
      email: 'editor@acme.fr',
      nom: 'Dupont',
      prenom: 'Marie',
      role: UserRole.EDITOR,
      clientId: clientEcommerce.id,
      supabaseId: 'editor-acme-id'
    }
  })

  const adminDemo = await prisma.user.create({
    data: {
      email: 'demo@demo.com',
      nom: 'Demo',
      prenom: 'User',
      role: UserRole.ADMIN,
      clientId: clientDemo.id,
      supabaseId: 'admin-demo-id'
    }
  })

  console.log(`‚úÖ Created 4 users`)

  // 4. Cr√©er quelques projets pour Acme E-commerce (depuis les templates)
  console.log('Creating projects for Acme E-commerce...')

  const seoGapsTemplate = templates.find(t => t.titre.includes('SEO - Gaps'))
  const crossSellingTemplate = templates.find(t => t.titre.includes('Cross-Selling'))
  const checkoutTemplate = templates.find(t => t.titre.includes('Checkout'))
  const stockTemplate = templates.find(t => t.titre.includes('stocks'))
  const carteTemplate = templates.find(t => t.titre.includes('Carte Cadeau'))

  await prisma.project.createMany({
    data: [
      {
        clientId: clientEcommerce.id,
        titre: '[SEO - Gaps] Cr√©ation pages listes de produits',
        categorie: 'Contenu SEO - Gaps',
        description: 'Avec ElasticSuite, cr√©ation de cat√©gories virtuelles pour combler les gaps SEO identifi√©s dans l\'analyse. Aucun d√©veloppement n√©cessaire, juste de la configuration.',
        budget: 10000,
        delaiSemaines: 2,
        kpi: 'Trafic SEO',
        scores: {
          impactBusiness: 9,
          complexite: 2,
          budgetScore: 8
        },
        additionalInfo: 'ElasticSuite permet de cr√©er des cat√©gories sans d√©veloppement. Configuration uniquement.',
        statut: 'BACKLOG',
        templateId: seoGapsTemplate?.id,
        createdById: adminAcme.id
      },
      {
        clientId: clientEcommerce.id,
        titre: 'Cross-Selling intelligent',
        categorie: 'Conversion',
        description: 'Syst√®me de recommandations produits bas√© sur l\'IA pour augmenter le panier moyen et am√©liorer l\'exp√©rience client.',
        budget: 7000,
        delaiSemaines: 1,
        kpi: 'Panier moyen',
        scores: {
          impactBusiness: 9,
          complexite: 4,
          budgetScore: 7
        },
        additionalInfo: '√âtude IA n√©cessaire pour d√©terminer les meilleurs algorithmes de recommandation.',
        statut: 'BACKLOG',
        templateId: crossSellingTemplate?.id,
        createdById: adminAcme.id
      },
      {
        clientId: clientEcommerce.id,
        titre: 'Optimisation Checkout',
        categorie: 'Conversion',
        description: 'Refonte du tunnel de commande pour r√©duire les frictions et augmenter le taux de conversion.',
        budget: 15000,
        delaiSemaines: 3,
        kpi: 'Taux de conversion',
        scores: {
          impactBusiness: 10,
          complexite: 6,
          budgetScore: 6
        },
        additionalInfo: 'Checkout optimis√© n√©cessite adaptation th√®me. ROI √©lev√© attendu.',
        statut: 'BACKLOG',
        templateId: checkoutTemplate?.id,
        createdById: adminAcme.id
      },
      {
        clientId: clientEcommerce.id,
        titre: 'Affichage stocks temps r√©el',
        categorie: 'Logistique',
        description: 'Int√©gration API pour afficher la disponibilit√© produits en temps r√©el sur le site.',
        budget: 4000,
        delaiSemaines: 1,
        kpi: 'Satisfaction client',
        scores: {
          impactBusiness: 7,
          complexite: 3,
          budgetScore: 9
        },
        additionalInfo: 'API logistique √† int√©grer. 4 jours de d√©veloppement estim√©s.',
        statut: 'BACKLOG',
        templateId: stockTemplate?.id,
        createdById: adminAcme.id
      },
      {
        clientId: clientEcommerce.id,
        titre: 'Module Carte Cadeau digitale',
        categorie: 'Conversion',
        description: 'Mise en place de cartes cadeaux num√©riques.',
        budget: 4000,
        delaiSemaines: 1,
        kpi: 'CA Cartes cadeaux',
        scores: {
          impactBusiness: 8,
          complexite: 2,
          budgetScore: 9
        },
        additionalInfo: 'Module carte cadeau. Installation 2j + adaptation th√®me 1-2j.',
        statut: 'BACKLOG',
        templateId: carteTemplate?.id,
        createdById: adminAcme.id
      }
    ]
  })

  console.log(`‚úÖ Created 5 projects for Acme E-commerce`)

  // 5. Cr√©er quelques projets pour Demo
  await prisma.project.createMany({
    data: [
      {
        clientId: clientDemo.id,
        titre: 'Refonte UX Homepage',
        categorie: 'UX Design',
        description: 'Am√©lioration de l\'exp√©rience utilisateur sur la page d\'accueil pour augmenter l\'engagement.',
        budget: 8000,
        delaiSemaines: 3,
        kpi: 'Taux d\'engagement',
        scores: {
          impactBusiness: 6,
          complexite: 4,
          budgetScore: 7
        },
        statut: 'BACKLOG',
        createdById: adminDemo.id
      },
      {
        clientId: clientDemo.id,
        titre: 'Module blog & contenus',
        categorie: 'Content Marketing',
        description: 'Cr√©ation d\'un blog avec CMS pour am√©liorer le r√©f√©rencement naturel et l\'engagement.',
        budget: 12000,
        delaiSemaines: 4,
        kpi: 'Trafic organique',
        scores: {
          impactBusiness: 7,
          complexite: 5,
          budgetScore: 6
        },
        statut: 'BACKLOG',
        createdById: adminDemo.id
      }
    ]
  })

  console.log(`‚úÖ Created 2 projects for Demo`)

  console.log('‚úÖ Seed completed successfully!')
}

main()
  .catch((e) => {
    console.error('‚ùå Seed failed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
